= Pixi Tasks Guide for Meso Forge Mirror
:toc: left
:toclevels: 3
:sectanchors:
:sectlinks:
:sectnums:
:source-highlighter: highlight.js
:icons: font
:experimental:

This guide explains how to use the pixi tasks defined for the `meso-forge-mirror` project. These tasks provide a comprehensive workflow for building, testing, and packaging the application as conda packages.

== Setup and Installation

=== Initial Setup

. *Install pixi* (if not already installed):
+
[source,bash]
----
curl -fsSL https://pixi.sh/install.sh | bash
----

. *Initialize the environment*:
+
[source,bash]
----
pixi install
----

. *Activate the environment*:
+
[source,bash]
----
pixi shell
----

The activation will automatically run setup scripts that:

* Check system dependencies
* Set environment variables
* Create necessary directories
* Verify Rust toolchain

== Core Development Tasks

=== Building the Project

[source,bash]
----
# Basic build (debug mode)
pixi run build

# Release build (optimized)
pixi run build-release

# Check code without building
pixi run check

# Clean build artifacts
pixi run clean

# Build with interactive platform selection (Nushell script)
pixi run build-platform
----

=== Testing and Code Quality

[source,bash]
----
# Run all tests
pixi run test

# Run tests with verbose output
pixi run test-verbose

# Run clippy linter
pixi run clippy

# Format code
pixi run fmt

# Check formatting without modifying files
pixi run fmt-check

# Complete development setup (build + test + lint + format check)
pixi run dev-setup

# CI-style check (includes release build)
pixi run ci-check
----

==== Nushell-Based Testing

[source,bash]
----
# Run unit tests with Nushell script
pixi run test-nu

# Run all test suites
pixi run test-all-nu

# Run integration tests
pixi run test-integration-nu

# Run linting checks
pixi run test-lint-nu

# Test local mirroring functionality
pixi run test-local-mirror

# Test configuration generation
pixi run test-config-nu

# Performance testing
pixi run test-performance
----

=== Documentation

[source,bash]
----
# Generate and open documentation
pixi run doc

# Build documentation without opening
pixi run docs-build

# Build all documentation including private items
pixi run docs-all

# Serve documentation on localhost:8000
pixi run docs-serve
----

== Conda Package Building

=== Traditional Conda-Build

[source,bash]
----
# Build package for current platform
pixi run conda-build

# Build packages for all supported platforms
pixi run conda-build-all

# Build for specific platforms
pixi run conda-build-linux
pixi run conda-build-macos
pixi run conda-build-macos-arm
pixi run conda-build-windows

# Cross-platform build with custom script
pixi run conda-build-cross
----

=== Modern Rattler-Build

[source,bash]
----
# Build with rattler-build (current platform)
pixi run rattler-build

# Build for all platforms with rattler-build
pixi run rattler-build-all
----

=== Package Verification

[source,bash]
----
# Verify conda package integrity
pixi run conda-verify

# Install and test locally built package
pixi run conda-test-local

# Create test environment with the package
pixi run conda-create-env
----

==== Nushell Conda Operations

[source,bash]
----
# Show help for conda operations
pixi run conda-ops

# Build conda packages with Nushell script
pixi run conda-build-nu

# Build for all platforms with Nushell
pixi run conda-build-all-nu

# Test package installation
pixi run conda-test-nu

# Verify package integrity
pixi run conda-verify-nu

# Publish packages
pixi run conda-publish-nu

# List available packages
pixi run conda-list-nu

# Clean conda build artifacts
pixi run conda-clean-nu
----

== Publishing and Distribution

=== Uploading to Conda Channels

[source,bash]
----
# Upload to conda-forge (requires permissions)
pixi run publish-conda-forge

# Upload to custom channel (set CONDA_CHANNEL env var)
pixi run upload-channel

# Upload to test channel
pixi run upload-test-channel

# Upload all built packages
pixi run upload-all-packages
----

=== Publishing to prefix.dev

[source,bash]
----
# Upload to prefix.dev
pixi run publish-prefix-dev

# Upload all rattler-built packages
pixi run upload-all-rattler
----

== Testing with Different Backends

=== Local Repository Testing

[source,bash]
----
# Basic local mirror demo
pixi run demo-local

# Integration test with local mirror
pixi run test-local-mirror

# Test configuration generation
pixi run test-config-generation

# Run complete integration tests
pixi run integration-test
----

=== S3/MinIO Testing

[source,bash]
----
# Test with local MinIO instance
pixi run test-s3-local
----

=== prefix.dev Testing

[source,bash]
----
# Test uploading to prefix.dev
pixi run test-prefix-dev
----

== Cross-Compilation Tasks

[source,bash]
----
# Build for specific targets
pixi run build-linux
pixi run build-macos
pixi run build-macos-arm
pixi run build-windows
----

== Maintenance and Development Tools

=== Dependency Management

[source,bash]
----
# Update dependencies
pixi run update

# Check for outdated dependencies
pixi run deps-outdated

# Security audit
pixi run security-audit
----

=== Development Tools Installation

[source,bash]
----
# Install development tools
pixi run install-dev-tools

# Complete development setup
pixi run setup-dev
----

=== File Watching for Development

[source,bash]
----
# Watch files and run checks/tests on changes
pixi run watch

# Watch and run tests only
pixi run watch-test
----

== Nushell Scripts

The project includes modern Nushell-based scripts that provide enhanced functionality and better cross-platform support:

=== Build Script (`scripts/build.nu`)

The Nushell build script provides interactive platform selection and comprehensive build options:

[source,bash]
----
# Interactive platform selection
nu scripts/build.nu

# Build for specific platform
nu scripts/build.nu linux-64
nu scripts/build.nu osx-arm64
nu scripts/build.nu win-64

# Debug build for current platform
nu scripts/build.nu debug

# Show help
nu scripts/build.nu --help
----

Features:
* Interactive platform selection
* Proper conda environment setup
* AWS SDK compatibility
* Cross-compilation support
* OpenSSL verification
* Build configuration display

=== Conda Operations Script (`scripts/conda-ops.nu`)

Comprehensive conda package operations:

[source,bash]
----
# Build packages for all platforms
nu scripts/conda-ops.nu build

# Build with rattler-build
nu scripts/conda-ops.nu build-rattler

# Test package installation
nu scripts/conda-ops.nu test linux-64

# Verify package integrity
nu scripts/conda-ops.nu verify package.conda

# Publish to channel
nu scripts/conda-ops.nu publish meso-forge

# Publish to prefix.dev
nu scripts/conda-ops.nu publish-prefix
----

=== Testing Script (`scripts/test.nu`)

Advanced testing capabilities:

[source,bash]
----
# Run unit tests
nu scripts/test.nu unit

# Run integration tests
nu scripts/test.nu integration

# Run all cargo tests
nu scripts/test.nu cargo

# Linting and formatting checks
nu scripts/test.nu lint

# Test local mirroring
nu scripts/test.nu local-mirror

# Performance testing
nu scripts/test.nu performance

# Package validation
nu scripts/test.nu package-validation
----

== Advanced Tasks

=== Binary Installation

[source,bash]
----
# Install release binary globally
pixi run install

# Install debug binary globally
pixi run install-debug
----

=== Performance Profiling

[source,bash]
----
# Profile application performance (Linux only)
pixi run profile
----

=== Examples and Demos

[source,bash]
----
# Generate example configuration
pixi run run-example
----

== Cleanup Tasks

[source,bash]
----
# Clean all build artifacts
pixi run clean-all

# Clean specific components
pixi run clean-examples
pixi run clean-integration
pixi run clean-packages
pixi run clean-build-artifacts
----

== Release Workflow

=== Complete Release Preparation

[source,bash]
----
# Prepare for release (full testing and building)
pixi run prepare-release

# Pre-release checks
pixi run pre-release
----

== Environment-Specific Tasks

The pixi configuration includes environment-specific tasks:

=== Development Environment

[source,bash]
----
# Switch to development environment
pixi shell -e dev
----

=== Testing Environment

[source,bash]
----
# Switch to testing environment
pixi shell -e test
----

=== Packaging Environment

[source,bash]
----
# Switch to packaging environment (includes conda-build tools)
pixi shell -e packaging
----

== Platform-Specific Considerations

=== Linux

* Requires `pkg-config` and `libssl-dev`
* Full cross-compilation support available

=== macOS

* Requires `pkg-config` and `openssl` from Homebrew
* Supports both Intel (osx-64) and Apple Silicon (osx-arm64)

=== Windows

* Uses MSVC toolchain by default
* Some tasks may require Windows Subsystem for Linux (WSL) or Git Bash

== Environment Variables

Key environment variables that affect task behavior:

`RUST_LOG`:: Set logging level (default: `info`)
`RUST_BACKTRACE`:: Enable backtraces (default: `1`)
`CONDA_CHANNEL`:: Target conda channel for uploads (default: `meso-forge`)
`AWS_*`:: AWS credentials for S3 testing
`GITHUB_TOKEN`:: GitHub API token for accessing staged recipes

== Common Workflows

=== Daily Development

[source,bash]
----
pixi run dev-setup    # Build, test, lint, format check
pixi run watch        # Continuous development with file watching
----

=== Before Committing

[source,bash]
----
pixi run ci-check     # Full CI-style verification
----

=== Building Packages

[source,bash]
----
pixi run conda-build-all     # Build for all platforms
pixi run conda-test-local    # Test installation
----

=== Publishing Release

[source,bash]
----
pixi run prepare-release     # Complete preparation
pixi run upload-all-packages # Publish to channels
----

== Troubleshooting

=== Common Issues

. *Missing system dependencies*: Run the setup script manually:
+
[source,bash]
----
bash scripts/setup-env.sh  # Linux/macOS
scripts/setup-env.bat      # Windows
----

. *Nushell not available*: Install Nushell for enhanced script functionality:
+
[source,bash]
----
# Install via cargo
cargo install nu

# Or via conda
conda install -c conda-forge nushell

# Or via package manager (varies by OS)
brew install nushell  # macOS
sudo apt install nushell  # Ubuntu/Debian
----

. *Cross-compilation failures*: Ensure required Rust targets are installed:
+
[source,bash]
----
rustup target add x86_64-unknown-linux-gnu
rustup target add x86_64-apple-darwin
rustup target add aarch64-apple-darwin
rustup target add x86_64-pc-windows-gnu
----

. *Conda build failures*: Verify conda-build is properly installed:
+
[source,bash]
----
pixi shell -e packaging
conda install conda-build
----

=== Getting Help

* List all available tasks: `pixi task list`
* View task details: `pixi info`
* Check environment status: `pixi list`

== Integration with CI/CD

The pixi tasks are designed to work seamlessly with the GitHub Actions workflows:

* `ci-check` task mirrors the CI pipeline
* Conda packaging tasks generate artifacts for release workflows
* Cross-compilation tasks ensure platform compatibility
* Nushell scripts provide enhanced functionality with better error handling and cross-platform support

=== Nushell Script Benefits

The new Nushell scripts offer several advantages over traditional shell scripts:

* **Cross-platform compatibility**: Works consistently across Linux, macOS, and Windows
* **Better error handling**: Structured error reporting with colored output
* **Interactive features**: User-friendly prompts and selections
* **Structured data handling**: Better parsing and processing of complex data
* **Comprehensive logging**: Detailed progress reporting with timestamps
* **Type safety**: Reduced runtime errors through Nushell's type system

This comprehensive task system provides a complete development, testing, and deployment workflow for the meso-forge-mirror project.
